name: Build generate push
permissions:
  contents: read
on: [push]
jobs:
  list-modules:
    runs-on: ubuntu-latest
    outputs:
      dir: ${{ steps.set-dirs.outputs.dir }}
      # We force 'changed' to true if the commit message contains [run-all]
      changed: ${{ contains(github.event.head_commit.message, '[run-all]') || steps.changed-files.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch all history to ensure we can find all go.mod files

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          dir_names: true
          dir_names_exclude_current_dir: true
          files_ignore: .github/**

      - name: Determine modules to run
        id: set-dirs
        run: |
          # Check if the commit message contains [run-all]
          IF_RUN_ALL="${{ contains(github.event.head_commit.message, '[run-all]') }}"
          
          if [ "$IF_RUN_ALL" = "true" ]; then
            echo "Force running all modules due to [run-all] in commit message"
            # Find all directories containing a go.mod file
            modules=$(find . -name "go.mod" -exec dirname {} \;)
          else
            # Original logic: only modules with changed files
            modules=$(for changed_dir in ${{ steps.changed-files.outputs.all_changed_files }}; do
              # Ensure the directory exists before running go list
              if [ -d "./$changed_dir" ]; then
                echo $(cd ./$changed_dir && go list -f '{{.Module.Dir}}' "./..." 2>/dev/null)
              fi
            done | sort -u)
          fi

          # Format modules as a JSON array for the matrix
          dir=$(echo "$modules" | sed 's|^\./||' | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0)) | unique')
          
          echo "dir=$dir" >> $GITHUB_OUTPUT
          echo "Selected modules: $dir"

  build-modules:
    # This will now trigger if files changed OR if [run-all] was used
    if: needs.list-modules.outputs.changed == 'true'
    runs-on: ubuntu-latest
    needs: [list-modules]
    continue-on-error: true
    strategy:
      max-parallel: 5
      matrix:
        dir: ${{ fromJson(needs.list-modules.outputs.dir) }}
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "^1.20"
          cache-dependency-path: ${{ matrix.dir }}/go.mod
          # Force a fresh cache if [run-all] is present (optional)
          cache: ${{ !contains(github.event.head_commit.message, '[run-all]') }}

      - name: Start lib
        run: echo Building ${{ matrix.dir }}

      - name: Build
        run: make all DIR=${{ matrix.dir }}

      - name: Lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: ${{ matrix.dir }}
          args: --timeout 5m
          skip-pkg-cache: true
          skip-build-cache: true

      - name: Test
        run: make test DIR=${{ matrix.dir }}
        
  # this step is needed for GH step validation to verify all build steps succeeded
  build-success:
    runs-on: ubuntu-latest
    needs: [build-modules]
    continue-on-error: false
    steps:
      - name: Success
        run: echo ok